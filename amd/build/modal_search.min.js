define ("mod_rki/modal_search",["exports","jquery","core/ajax","core/modal_factory","core/modal_events","core/notification","core/modal","core/custom_interaction_events","core/modal_registry","mod_rki/modal_book","mod_rki/modal_book_handle"],function(a,b,c,d,e,f,g,h,i){b.fn.serializeAssoc=function(){var c={};b.each(this.serializeArray(),function(d,e){var f=e.name.match(/(.*?)\[(.*?)\]/);if(null!==f){var a=f[1],g=f[2];if(!c[a]){c[a]=[]}if(!g.length){g=c[a].length}if(c[a][g]){if(b.isArray(c[a][g])){c[a][g].push(e.value)}else{c[a][g]=[];c[a][g].push(e.value)}}else{c[a][g]=e.value}}else{if(c[e.name]){if(b.isArray(c[e.name])){c[e.name].push(e.value)}else{c[e.name]=[];c[e.name].push(e.value)}}else{c[e.name]=e.value}}});return c};var j={SEARCH_TEXTBOX:"[data-action='search_text']",START_SEARCH:"[data-action='search_button']",START_SEARCH_CLEAR:"[name='clear_search']",CANCEL_BUTTON:"[data-action='cancel_button']",CONTENT_BLOCK:"[data-action='content_block']",CONTENT_NAME:"[name='content_name']",TRIGGER_BOOK:".trigger_book",ADD_BOOK:"[name='add_book']",CATEGORY_BUTTON:"[data-action='category_tree']",CATEGORY_BLOCK:"[data-action='categories']",LEVEL_BLOCK:"[data-action='levels']",BOOK_PAGINATION:"#books_pagination li.page-item",START_PAGE_CLASS:"page-start",END_PAGE_CLASS:"page-end",PROGRESS:".loader"},k=10,l=function(a){g.call(this,a);if(!this.getBody().find(j.SEARCH_TEXTBOX).length){f.exception({message:"text box not found"})}if(!this.getBody().find(j.START_SEARCH).length){f.exception({message:"search button not found"})}};l.TYPE="mod_rki-search";l.prototype=Object.create(g.prototype);l.prototype.constructor=l;l.prototype.registerEventListeners=function(){g.prototype.registerEventListeners.call(this);var a=function(a){a.preventDefault();a.stopPropagation();var c=b(j.CATEGORY_BLOCK).attr("data-id"),d=b(j.LEVEL_BLOCK).attr("data-id"),e={searchParam:b(a.target.form).serializeAssoc(),page:1,limit:k,catId:c,levelId:d};b(j.PROGRESS).toggleClass("hide");l.prototype.getAjaxCall("mod_rki_search_books",e,l.prototype.getSearchResult).then(function(){l.prototype.resetPagination();b(j.PROGRESS).toggleClass("hide")})};this.getModal().on(h.events.activate,j.START_SEARCH,a.bind(this));this.getModal().on("click",j.START_SEARCH_CLEAR,function(a){a.preventDefault();a.stopPropagation();b(j.SEARCH_TEXTBOX).val("");b(j.START_SEARCH).trigger("click");return!1});this.getModal().on("keypress",j.SEARCH_TEXTBOX,function disabledEnterSubmit(b){if(13===b.keyCode){a(b);return!1}}.bind(this));this.getModal().on(h.events.activate,j.BOOK_PAGINATION,function setPagination(a){if(b(a.currentTarget).hasClass("disabled")){return!0}var c,d;if(b(j.CONTENT_BLOCK).attr("data-page")===void 0){d=0}else{d=parseInt(b(j.CONTENT_BLOCK).attr("data-page"))}if(b(a.currentTarget).hasClass(j.START_PAGE_CLASS)){if(0<d){c=1}else{c=0}}else if(b(a.currentTarget).hasClass(j.END_PAGE_CLASS)){c=d}else{c=parseInt(b(a.currentTarget).attr("data-page"))}var e=b(j.CATEGORY_BLOCK).attr("data-id"),f=b(j.LEVEL_BLOCK).attr("data-id"),g={searchParam:{searchString:b(j.SEARCH_TEXTBOX).val()},page:c,limit:k,catId:e,levelId:f},h=b(j.BOOK_PAGINATION).find("a.prev").closest("li.page-item"),i=b(j.BOOK_PAGINATION).find("a.next").closest("li.page-item"),m=b(j.BOOK_PAGINATION).find("a.active").closest("li.page-item");if(2<=c){b(h).attr("data-page",c-1);b(h).removeClass("disabled")}else if(1===c){b(h).attr("data-page",c-1);b(h).addClass("disabled")}if(d===c){b(i).addClass("disabled")}else{b(i).removeClass("disabled")}b(i).attr("data-page",c+1);b(m).attr("data-page",c);b(m).find("a.active").text(c+" \u0438\u0437 "+d);if(0!==c&&0!==d){l.prototype.getAjaxCall("mod_rki_search_books",g,l.prototype.getSearchResult)}}.bind(this));this.getModal().on("keydown",j.CONTENT_NAME,function disabledKeyUp(a){if(!1!==a.keyCode){a.preventDefault();return!1}}.bind(this));this.getModal().on(h.events.activate,j.CANCEL_BUTTON,function(){b(this).trigger("hide")}.bind(this));this.getModal().on(h.events.activate,j.CATEGORY_BUTTON,function getCategoryTree(a){a.preventDefault();a.stopPropagation();l.prototype.getAjaxCall("mod_rki_category_tree",{categoryId:[null]},l.prototype.printCategories)}.bind(this))};l.prototype.getSearchResult=function(a){b(j.CONTENT_BLOCK).empty();var c=Math.ceil(a.meta.total/k);if(0<a.meta.total){b.each(a.data,function(a,c){var d="<a class=\"\" data-toggle=\"collapse\" href=\"#collapseDescription"+c.id+"\" role=\"button\">\u041F\u043E\u0434\u0440\u043E\u0431\u043D\u0435\u0435 \u043E\u0431 \u0438\u0437\u0434\u0430\u043D\u0438\u0438</a><br><div class=\"collapse\" id=\"collapseDescription"+c.id+"\"><span><strong>\u041E\u043F\u0438\u0441\u0430\u043D\u0438\u0435: </strong>"+c.description+"</span><br><br><span><strong>ISBN: </strong>"+c.isbn+"</span><br><br></div>";if(null===c.description||""===c.description){c.description="";d=""}if(null===c.authors||""===c.authors){c.authors=""}b(j.CONTENT_BLOCK).append("<div class=\"row\" data-id=\""+c.book_id+"\"><div class=\"col-sm-2\" ><img src=\"https://www.ros-edu.ru/"+c.image+"\" class=\"img-responsive thumbnail\" alt=\"\"></div><div class=\"col-sm-8\"><span class=\"book_title\" data-val=\""+c.title+"\"><strong>\u041D\u0430\u0437\u0432\u0430\u043D\u0438\u0435: </strong>"+c.title+"</span><br><span class=\"book_authors\" data-val=\""+c.authors+"\"><strong>\u0410\u0432\u0442\u043E\u0440\u044B: </strong>"+c.authors+"</span><br><span><strong>\u0418\u0437\u0434\u0430\u0442\u0435\u043B\u044C\u0441\u0442\u0432\u043E: </strong>"+c.pubhouses+"</span><br><span><strong>\u0413\u043E\u0434 \u0438\u0437\u0434\u0430\u043D\u0438\u044F: </strong>"+c.year+"</span><br><span><strong>\u0422\u0438\u043F \u0438\u0437\u0434\u0430\u043D\u0438\u044F: </strong>"+c.longtitle+"</span><br><br><span class=\"book_title_additional\" style=\"display: none\" data-val=\""+c.longtitle+"\">"+c.longtitle+"</span><br>"+d+"</div><div class=\"col-sm-2\"><button type=\"button\" name=\"add_book\" class=\"btn btn-sm\" style=\"color: #a53436;background-color: white;border-color: #a53436;width: 140px;\">\u0414\u043E\u0431\u0430\u0432\u0438\u0442\u044C</button><button type=\"button\" class=\"trigger_book btn btn-sm mt-2\" style=\"color: #a53436;background-color: white;border-color: #a53436;width: 140px;\">\u041F\u0440\u0435\u0434\u043F\u0440\u043E\u0441\u043C\u043E\u0442\u0440</button><br></div></div><hr>")})}else{b(j.CONTENT_BLOCK).append("<div class=\"item h4\">\u041A\u043D\u0438\u0433\u0438 \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u044B</div>")}b(j.CONTENT_BLOCK).attr("data-page",c);b(j.TRIGGER_BOOK).on("click",function(a){var c=b(a.target).closest(".row").attr("data-id");l.prototype.getAjaxCall("mod_rki_book_read_url",{bookId:c},function(a){var b=window.open(a.data,"_blank");b.focus()})});b(j.ADD_BOOK).on("click",function(a){var c=b(a.target).closest(".row").attr("data-id"),d=b("[name=\"content_name\"]");d.val(b(a.target).closest(".row").find(".book_title").attr("data-val"));d.removeClass("is-invalid");d.siblings("#id_error_content_name").text("");var e=b("[name=\"name\"]"),f=b(a.target).closest(".row").find(".book_authors").attr("data-val").split(","),g=b(a.target).closest(".row").find(".book_title").attr("data-val"),h=b(a.target).closest(".row").find(".book_title_additional").attr("data-val");e.val(f[0]+", "+g+": "+h);e.removeClass("is-invalid");e.siblings("#id_error_content_name").text("");b("[name=\"content\"]").val(c);b(j.CANCEL_BUTTON).trigger("click")})};l.prototype.printCategories=function(a){b(j.CATEGORY_BLOCK).empty();b.each(a.data,function(a,c){b(j.CATEGORY_BLOCK).append("<div style=\"cursor:pointer;color:#174c8d;background-color:white;\" class=\"item btn-sm"+(0===c.id?" bg-primary":"")+"\" data-id=\""+c.id+"\"><span>"+c.pagetitle+"</span></div>");b(j.CATEGORY_BLOCK).find("[data-id=\""+c.id+"\"]").click({item:c},function(a){a.stopPropagation();a.preventDefault();b(j.CATEGORY_BLOCK).attr("data-id",b(a.currentTarget).attr("data-id"));if(!b(this).hasClass("bg-primary")){b(this).addClass("bg-primary");b(this).siblings().removeClass("bg-primary")}b(j.START_SEARCH).trigger("click")})});b(j.CATEGORY_BLOCK).prepend("<div class=\"btn-sm\"><h5>\u041A\u0430\u0442\u0435\u0433\u043E\u0440\u0438\u0438</h5></div>")};l.prototype.printError=function(a){b(".modal-body").empty().append("<h2 style=\"text-align: center;\">\u041E\u0448\u0438\u0431\u043A\u0430: "+a.message+"<br/> \u041E\u0431\u0440\u0430\u0442\u0438\u0442\u0435\u0441\u044C \u0432 \u0441\u043B\u0443\u0436\u0431\u0443 \u0442\u0435\u0445\u043D\u0438\u0447\u0435\u0441\u043A\u043E\u0439 \u043F\u043E\u0434\u0434\u0435\u0440\u0436\u043A\u0438</h2>");b(".modal-footer").empty()};l.prototype.printLevels=function(a){b(j.LEVEL_BLOCK).empty();b.each(a.data,function(a,c){b(j.LEVEL_BLOCK).append("<div style=\"cursor:pointer;color:#174c8d;background-color:white;\" class=\"item btn-sm"+(0===c.id?" bg-primary":"")+"\" data-id=\""+c.id+"\"><span>"+c.level+"</span></div>");b(j.LEVEL_BLOCK).find("[data-id=\""+c.id+"\"]").click({item:c},function(a){a.stopPropagation();a.preventDefault();b(j.LEVEL_BLOCK).attr("data-id",b(a.currentTarget).attr("data-id"));if(!b(this).hasClass("bg-primary")){b(this).addClass("bg-primary");b(this).siblings().removeClass("bg-primary")}b(j.START_SEARCH).trigger("click")})});b(j.LEVEL_BLOCK).prepend("</br><div class=\"btn-sm\"><h5>\u041A\u0430\u0442\u0435\u0433\u043E\u0440\u0438\u0438</h5></div>")};l.prototype.getAjaxCall=function(a,b,d){return c.call([{methodname:a,args:b}])[0].then(function(a){return a}).done(function(a){var b=JSON.parse(a.body);if(b.meta!==void 0&&b.meta.success!==void 0&&!1!==b.meta.success){d(b)}else{l.prototype.printError(b)}return!0}).fail(function(){return!1})};l.prototype.preloadModalData=function(){var a={categoryId:[null]};l.prototype.getAjaxCall("mod_rki_category_tree",a,function(c){l.prototype.printCategories(c);l.prototype.getAjaxCall("mod_rki_level_tree",a,function(a){l.prototype.printLevels(a);b(j.START_SEARCH).trigger("click")})})};l.prototype.resetPagination=function(){var a=parseInt(b(j.CONTENT_BLOCK).attr("data-page"));b(j.BOOK_PAGINATION).find("a.prev").closest("li.page-item").addClass("disabled");b(j.BOOK_PAGINATION).find("a.prev").closest("li.page-item").attr("data-page",0);b(j.BOOK_PAGINATION).find("a.active").closest("li.page-item").attr("data-page",1);b(j.BOOK_PAGINATION).find("a.next").closest("li.page-item").attr("data-page",2);if(1<a){b(j.BOOK_PAGINATION).find("a.active").text("1 \u0438\u0437 "+a);b(j.BOOK_PAGINATION).find("a.next").closest("li.page-item").removeClass("disabled")}else{b(j.BOOK_PAGINATION).find("a.active").text(a+" \u0438\u0437 "+a);b(j.BOOK_PAGINATION).find("a.next").closest("li.page-item").addClass("disabled")}};i.register(l.TYPE,l,"mod_rki/modal_search");return l});
//# sourceMappingURL=modal_search.min.js.map
